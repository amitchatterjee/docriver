<!doctype html>

<html>
    <head>
        <title>Document Submission - Javascript</title>

        <script src="http://localhost:5000/js/uploader.js"></script>
        <script>
            function uuidv4() {
                return "10000000-1000-4000-8000-100000000000".replace(/[018]/g, c =>
                    (+c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> +c / 4).toString(16));
            }

            function onResult(e) {
                let submittedDocumentsElement = document.querySelector('#submittedDocuments');
                let submittedDocuments = JSON.parse(submittedDocumentsElement.value);
                let urls = [];
                for (doc of e.detail.documents) {
                    urls.push(doc.document);
                }
                
                submittedDocuments.push({[e.detail.tx]: urls});
                submittedDocumentsElement.value=JSON.stringify(submittedDocuments);
                submittedDocumentsElement.dispatchEvent(new Event('input', { 'bubbles': true }));
            }

            // function onError(e) {
            //    alert(JSON.stringify(e.detail, null, 2));
            //    e.preventDefault()
            //}

            function onPageLoad() {
                const controller = new AbortController();
                const signal = controller.signal;

                const uuid = uuidv4();
                const fetchPromise = fetch(new URL('http://localhost:8080/token'), {
                    method: 'POST',
                    cache: "no-cache",
                    headers: {
                        "Content-Type": "application/json",
                        "Accept": "application/json",
                    },
                    redirect: "follow",
                    body: JSON.stringify({subject: "amit", 
                        audience: "docriver", 
                        permissions: {txType: "submit", resourceType: "claim", refResourceId: "123456789", documentCount: 10, tx:uuid}}),
                    signal
                });

                fetchPromise.then(response => {
                if (response.status == 200) {
                    response.json().then(json=> {
                        console.log(json);
                        onToken(json.authorization, uuid)
                    });
                } else {
                    response.text().then(error=> {
                        alert(`Get token failed. Error: ${error}`);
                    });
                }
            }).catch(error => {
                console.error(`Error fetching token: ${error}`);
                alert(`Error while fetching token: ${error}`);
                }).finally(()=>{
                    clearTimeout(timerId);
                });
        
                const timerId = setTimeout(() => {
                    controller.abort(); // Abort the fetch request
                    console.error('Get token timed out');
                    alert('Get token timed out');
                }, 60000);   
            }

            function onToken(token, tx) {
                let div = document.querySelector('#docriverUploaderJs');
                let docUploader = document.createElement('docriver-uploader-basic');
                //docUploader.setAttribute("tx", tx);
                docUploader.setAttribute("docServer", "http://localhost:5000");
                docUploader.setAttribute("documentType", "medicalRecord");
                docUploader.setAttribute("realm", "p123456");
                docUploader.setAttribute("refResourceType", "claim");
                docUploader.setAttribute("refResourceId", "123456789");
                docUploader.setAttribute("refResourceDescription", "Supporting documents for appeals");
                // docUploader.setAttribute("onToken", "getToken");

                if (token) {
                    docUploader.setAttribute("authorization", token);
                }
                docUploader.addEventListener("result", onResult);
                // docUploader.addEventListener("error", onError);
                div.appendChild(docUploader);
            }

            function onAppealsSubmit(e) {
                e.preventDefault();
                let form = e.currentTarget;
                let formData = new FormData(form);

                for (var pair of formData.entries()) {
                    console.log(`${pair[0]}: ${pair[1]}`); 
                }
                resetUpload();
                form.reset();
                alert(`Appeals submitted.  Appeals Id: 123456`);
            }

            function onAppealsReset(e) {
                e.preventDefault();
                let form = e.currentTarget;       
                resetUpload();
                form.reset();
            }
        </script>
    </head>

    <body onload="onPageLoad()">
        <template id="docSubmissionTemplate">
            <style>
                .docriverSubmissionBox {
                  background: #1E88E5;
                  color: white;
                  padding: 1rem 1rem;
                  border: 0;
                  font-size: 1rem;
                }
            </style>

            <div class="docriverSubmissionBox">
                <div class="docriverSubmissionResult"></div>
                <br>
                Submit supporting documents - select one or more files using the file selectors. Click on the "Submit Documents" button to submit:
                <p></p>
                <form id="docriverSubmissionForm" method="POST" enctype="multipart/form-data">
                    <label for="file-medicalRecords">Medical records:</label>
                    <br>
                    <input type="file" id="file-medicalRecords" name="file-medicalRecords" multiple>
                    <input type="hidden" name="type-medicalRecords" value="medicalRecord">
                    
                    <p></p>
                    <label for="file-letters">Xray, CT Scan and other images:</label>
                    <br>
                    <input type="file" id="file-letters" name="file-letters" multiple>
                    <input type="hidden" name="type-letters" value="letters">
                    
                    <p></p>
                    <input type="submit" value="Submit Documents">
                    &nbsp;&nbsp;<input type="reset" value="Reset Documents">
                </form>
            </div>
        </template>
        <h2>
            Appeal payment decision for claim: <b>123456789</b>
        </h2>
        <p>
            <div id="docriverUploaderJs">
            </div>
        </p>
        <p>
            <form id="appealsForm" onsubmit="return onAppealsSubmit(event)" onreset="return onAppealsReset(event)">
                <input type="hidden" id="submittedDocuments" name="documents" value="[]">
                <input type="hidden" name="claim" value="123456789">
                <label for="additionalInformation">Additional Information:</label>
                <br>
                <textarea id="additionalInformation" name="additionalInformation" rows="4" cols="50" required></textarea>
                <br>
                <input type="submit" value="Submit">
                &nbsp;&nbsp;&nbsp;&nbsp;<input type="reset" value="Reset">
            </form>
        </p>
    </body>
</html>